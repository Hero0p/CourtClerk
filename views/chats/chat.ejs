<div class="container-fluid chat-container px-0 px-md-3">
  <div class="row g-0 h-100">
    <div class="col-md-12 h-100">
      <div class="card chat-card h-100">
        <div class="card-header bg-white shadow-sm border-0 d-flex justify-content-between align-items-center py-3">
          <div class="d-flex align-items-center overflow-hidden">
            <% if (chat.type==='lawyer' ) { %>
              <div class="bg-light rounded-circle p-2 me-3 flex-shrink-0">
                <i class="fas fa-user-tie text-primary"></i>
              </div>
              <% } else { %>
                <div class="bg-primary text-white rounded-circle p-2 me-3 flex-shrink-0">
                  <i class="fas fa-robot"></i>
                </div>
                <% } %>

                  <div class="overflow-hidden">
                    <h5 class="mb-0 text-truncate" id="chatTitle" style="font-size: 1.1rem;">
                      <%= chat.title %>
                    </h5>
                    <button class="btn btn-sm btn-link edit-title-btn p-0 text-muted" id="editTitleBtn"
                      style="font-size: 0.8rem;">
                      <i class="fas fa-pen me-1"></i> Edit Title
                    </button>
                  </div>
          </div>

          <div class="d-flex align-items-center flex-shrink-0 ms-2">
            <% if (chat.type==='lawyer' && chat.status !=='completed' ) { %>
              <button class="btn btn-sm btn-success me-2 d-none d-sm-inline-flex align-items-center" id="markAsDoneBtn"
                type="button">
                <i class="fas fa-check me-1"></i> Done
              </button>
              <% } %>
                <button class="btn btn-sm btn-outline-danger p-2 rounded-circle border-0" id="clearChatBtn"
                  type="button" title="Clear Chat">
                  <i class="fas fa-trash-alt"></i>
                </button>
          </div>
        </div>

        <!-- Edit Title Form (Hidden by default) -->
        <form id="editTitleForm" class="d-none px-3 py-2 bg-light border-bottom">
          <div class="input-group">
            <input type="text" class="form-control" id="newTitle" value="<%= chat.title %>">
            <button class="btn btn-primary" type="submit">Save</button>
            <button class="btn btn-outline-secondary" type="button" id="cancelEditBtn">Cancel</button>
          </div>
        </form>

        <div class="card-body chat-messages bg-light" id="chatMessages">
          <% if (chat.messages && chat.messages.length> 0) { %>
            <% chat.messages.forEach(message=> { %>
              <% if (message.sender && message.sender._id && message.sender._id.toString()===user.id) { %>
                <!-- User Message -->
                <div class="message user-message">
                  <div class="message-content shadow-sm">
                    <div class="message-text">
                      <%= message.content %>
                    </div>
                    <div class="message-time">
                      <%= new Date(message.timestamp).toLocaleTimeString([], {hour: '2-digit' , minute:'2-digit'}) %>
                    </div>
                  </div>
                  <div class="message-avatar">
                    <img src="<%= user.profilePicture || '/images/default-avatar.png' %>" alt="User"
                      class="rounded-circle shadow-sm">
                  </div>
                </div>
                <% } else if (chat.type==='lawyer' ) { %>
                  <!-- Lawyer Message -->
                  <div class="message lawyer-message">
                    <div class="message-avatar">
                      <% if (message.sender && message.sender.profilePicture) { %>
                        <img src="<%= message.sender.profilePicture %>" alt="Lawyer" class="rounded-circle shadow-sm">
                        <% } else { %>
                          <div class="lawyer-avatar shadow-sm">
                            <i class="fas fa-user-tie"></i>
                          </div>
                          <% } %>
                    </div>
                    <div class="message-content shadow-sm">
                      <div class="message-sender">
                        <%= message.sender ? message.sender.name || 'Advocate' : 'Advocate' %>
                      </div>
                      <!-- Rendering content raw for parsing, or pre-rendered -->
                      <div class="message-text markdown-content">
                        <%= message.content %>
                      </div>
                      <div class="message-time">
                        <%= new Date(message.timestamp).toLocaleTimeString([], {hour: '2-digit' , minute:'2-digit'}) %>
                      </div>
                    </div>
                  </div>
                  <% } else { %>
                    <!-- CourtClerk AI Message -->
                    <div class="message ai-message">
                      <div class="message-avatar">
                        <div class="ai-avatar shadow-sm">
                          <i class="fas fa-balance-scale"></i>
                        </div>
                      </div>
                      <div class="message-content shadow-sm">
                        <div class="message-sender">
                          CourtClerk AI
                        </div>
                        <!-- Mark for Markdown Parsing -->
                        <div class="message-text markdown-content">
                          <%= message.content %>
                        </div>
                        <div class="message-time">
                          <%= new Date(message.timestamp).toLocaleTimeString([], {hour: '2-digit' , minute:'2-digit'})
                            %>
                        </div>
                      </div>
                    </div>
                    <% } %>
                      <% }) %>
                        <% } else { %>
                          <div class="empty-chat h-100">
                            <% if (chat.type==='lawyer' ) { %>
                              <div class="bg-white p-4 rounded-circle shadow-sm mb-4">
                                <i class="fas fa-gavel fa-3x text-primary"></i>
                              </div>
                              <h4 class="fw-bold mb-2">Consult with an Advocate</h4>
                              <p class="text-muted" style="max-width: 400px;">
                                Start the conversation to get professional legal advice and representation.
                              </p>
                              <% } else { %>
                                <div class="bg-white p-4 rounded-circle shadow-sm mb-4">
                                  <i class="fas fa-balance-scale fa-3x text-primary"></i>
                                </div>
                                <h4 class="fw-bold mb-2">CourtClerk AI Assistant</h4>
                                <p class="text-muted" style="max-width: 400px;">
                                  Ask me about Indian laws, rights, or legal procedures. I'm here to help clarify
                                  complex legal information.
                                </p>
                                <div class="d-flex gap-2 mt-3 flex-wrap justify-content-center">
                                  <button class="btn btn-outline-primary btn-sm rounded-pill px-3 suggestion-btn">What
                                    are my rights upon arrest?</button>
                                  <button class="btn btn-outline-primary btn-sm rounded-pill px-3 suggestion-btn">How to
                                    file an FIR?</button>
                                </div>
                                <% } %>
                          </div>
                          <% } %>
        </div>

        <div class="card-footer bg-white border-top-0 p-3 pt-0">
          <form id="chatForm">
            <div class="input-group shadow-sm">
              <input type="text" id="messageInput" class="form-control"
                placeholder="<%= chat.type === 'lawyer' ? 'Type your message to the lawyer...' : 'Ask a legal question...' %>"
                autocomplete="off" required>
              <button class="btn btn-primary rounded-circle m-1 d-flex align-items-center justify-content-center"
                style="width: 40px; height: 40px;" type="submit" id="sendMessageBtn">
                <i class="fas fa-paper-plane text-white"></i>
                <div class="spinner-border spinner-border-sm text-white d-none" role="status">
                  <span class="visually-hidden">Loading...</span>
                </div>
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal code remains same, updated via separate tool if needed for ID consistency -->
<div class="modal fade" id="clearChatModal" tabindex="-1" aria-labelledby="clearChatModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content border-0 shadow">
      <div class="modal-header border-0">
        <h5 class="modal-title fw-bold" id="clearChatModalLabel">Clear Consultation?</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-muted">
        Are you sure you want to clear this entire conversation history? This action cannot be undone.
      </div>
      <div class="modal-footer border-0">
        <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger px-4" id="confirmClearBtn">Delete History</button>
      </div>
    </div>
  </div>
</div>

<!-- Styles removed here as they are now in style.css global file -->

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const socket = io();
    const chatForm = document.getElementById('chatForm');
    const messageInput = document.getElementById('messageInput');
    const chatMessages = document.getElementById('chatMessages');
    const chatId = '<%= chat._id %>';

    // Suggestion buttons
    document.querySelectorAll('.suggestion-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        messageInput.value = btn.innerText;
        messageInput.focus();
      });
    });

    // Markdown Rendering Function
    function renderMarkdown() {
      if (typeof marked !== 'undefined' && typeof DOMPurify !== 'undefined') {
        document.querySelectorAll('.markdown-content').forEach(el => {
          if (!el.getAttribute('data-rendered')) {
            const rawContent = el.innerHTML
              .replace(/&lt;/g, '<')
              .replace(/&gt;/g, '>')
              .replace(/&amp;/g, '&'); // Basic unescape

            // Configure marked for safe basic parsing
            marked.use({
              breaks: true,
              gfm: true
            });

            const parsed = marked.parse(rawContent);
            const clean = DOMPurify.sanitize(parsed);
            el.innerHTML = clean;
            el.setAttribute('data-rendered', 'true');
          }
        });
      }
    }

    // Initial render
    setTimeout(renderMarkdown, 100);

    // Initialize Bootstrap Modal
    const clearChatModal = new bootstrap.Modal(document.getElementById('clearChatModal'), {
      keyboard: false,
      backdrop: 'static'
    });

    function scrollToBottom() {
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    scrollToBottom();

    function showTypingIndicator() {
      const div = document.createElement('div');
      div.className = 'message ai-message';
      div.id = 'typingIndicator';
      div.innerHTML = `
      <div class="message-avatar">
        <div class="ai-avatar shadow-sm">
          <i class="fas fa-balance-scale"></i>
        </div>
      </div>
      <div class="message-content shadow-sm">
        <div class="typing-indicator">
          <span></span>
          <span></span>
          <span></span>
        </div>
      </div>
    `;
      chatMessages.appendChild(div);
      scrollToBottom();
    }

    function removeTypingIndicator() {
      const indicator = document.getElementById('typingIndicator');
      if (indicator) {
        indicator.remove();
      }
    }

    const sendMessageBtn = document.getElementById('sendMessageBtn');
    let isSending = false;

    function setLoadingState(loading) {
      isSending = loading;
      const spinner = sendMessageBtn.querySelector('.spinner-border');
      const icon = sendMessageBtn.querySelector('.fa-paper-plane');

      messageInput.disabled = loading;
      sendMessageBtn.disabled = loading;

      if (loading) {
        spinner.classList.remove('d-none');
        icon.classList.add('d-none');
      } else {
        spinner.classList.add('d-none');
        icon.classList.remove('d-none');
      }
    }

    // Update chat form submission
    chatForm.addEventListener('submit', async function (e) {
      e.preventDefault();

      const message = messageInput.value.trim();
      if (!message || isSending) return;

      try {
        setLoadingState(true);

        // Add user message to UI immediately
        addMessageToUI(message, true);

        // Clear input
        messageInput.value = '';

        // Show typing indicator
        showTypingIndicator();

        // Send to server
        const response = await fetch(`/chats/${chatId}/message`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ message })
        });

        if (!response.ok) {
          throw new Error('Failed to send message');
        }

        const data = await response.json();

        if (data.success) {
          // Remove typing indicator
          removeTypingIndicator();
          // Add AI response to UI
          addMessageToUI(data.aiMessage.content, false);
        } else {
          throw new Error(data.error || 'Failed to process message');
        }
      } catch (error) {
        console.error('Error:', error);
        removeTypingIndicator();
        showNotification('Failed to send message. Please try again.', 'error');
        addErrorMessageToUI();
      } finally {
        setLoadingState(false);
        messageInput.focus();
      }
    });

    // Add keyboard shortcut for sending messages
    messageInput.addEventListener('keydown', function (e) {
      if (e.key === 'Enter' && !e.shiftKey && !isSending) {
        e.preventDefault();
        chatForm.dispatchEvent(new Event('submit'));
      }
    });

    // Clear chat functionality (kept same as before)
    const clearChatBtn = document.getElementById('clearChatBtn');
    const confirmClearBtn = document.getElementById('confirmClearBtn');

    clearChatBtn.addEventListener('click', () => {
      clearChatModal.show();
    });

    confirmClearBtn.addEventListener('click', async () => {
      try {
        const response = await fetch(`/chats/${chatId}/clear`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          }
        });

        if (!response.ok) {
          throw new Error('Network response was not ok');
        }

        const data = await response.json();

        if (data.success) {
          // Clear messages from UI
          chatMessages.innerHTML = `
          <div class="empty-chat h-100">
                <div class="bg-white p-4 rounded-circle shadow-sm mb-4">
                    <i class="fas fa-balance-scale fa-3x text-primary"></i>
                </div>
                <h4 class="fw-bold mb-2">CourtClerk AI Assistant</h4>
                <p class="text-muted" style="max-width: 400px;">
                    Ask me about Indian laws, rights, or legal procedures. I'm here to help clarify complex legal information.
                </p>
          </div>
        `;

          // Hide the modal
          clearChatModal.hide();

          // Show success message
          showNotification('Consultation history cleared successfully', 'success');
        } else {
          throw new Error(data.error || 'Failed to clear chat');
        }
      } catch (error) {
        console.error('Error clearing chat:', error);
        showNotification('Failed to clear chat history', 'error');
      }
    });

    function addMessageToUI(content, isUser) {
      const div = document.createElement('div');
      const currentTime = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

      if (isUser) {
        div.className = 'message user-message';
        div.innerHTML = `
        <div class="message-content shadow-sm">
          <div class="message-text">${content}</div>
          <div class="message-time">${currentTime}</div>
        </div>
        <div class="message-avatar">
          <img src="<%= user.profilePicture || '/images/default-avatar.png' %>" alt="User" class="rounded-circle shadow-sm">
        </div>
      `;
      } else if ('<%= chat.type %>' === 'lawyer') {
        div.className = 'message lawyer-message';
        div.innerHTML = `
        <div class="message-avatar">
          <div class="lawyer-avatar shadow-sm">
            <i class="fas fa-user-tie"></i>
          </div>
        </div>
        <div class="message-content shadow-sm">
          <div class="message-sender">Advocate</div>
          <div class="message-text markdown-content">${content}</div>
          <div class="message-time">${currentTime}</div>
        </div>
      `;
      } else {
        div.className = 'message ai-message';
        div.innerHTML = `
        <div class="message-avatar">
          <div class="ai-avatar shadow-sm">
            <i class="fas fa-balance-scale"></i>
          </div>
        </div>
        <div class="message-content shadow-sm">
          <div class="message-sender">CourtClerk AI</div>
          <div class="message-text markdown-content">${content}</div>
          <div class="message-time">${currentTime}</div>
        </div>
      `;
      }

      chatMessages.appendChild(div);
      scrollToBottom();

      if (!isUser) {
        renderMarkdown();
      }
    }

    function addErrorMessageToUI() {
      const div = document.createElement('div');
      div.className = 'message ai-message';
      div.innerHTML = `
      <div class="message-avatar">
        <div class="ai-avatar shadow-sm bg-danger border-danger">
          <i class="fas fa-exclamation-triangle"></i>
        </div>
      </div>
      <div class="message-content shadow-sm">
        <div class="message-sender text-danger">System Error</div>
        <div class="message-text text-danger">
          An error occurred while processing your request. Please try again or check your connection.
        </div>
        <div class="message-time">
          ${new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
        </div>
      </div>
    `;
      chatMessages.appendChild(div);
      scrollToBottom();
    }

    function showNotification(message, type = 'info') {
      const notificationDiv = document.createElement('div');
      // Using bootstrap alerts but positioned nicely
      notificationDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed top-0 end-0 m-3 shadow`;
      notificationDiv.style.zIndex = '1050';
      notificationDiv.innerHTML = `
      ${message}
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    `;
      document.body.appendChild(notificationDiv);

      // Remove notification after 3 seconds
      setTimeout(() => {
        notificationDiv.remove();
      }, 3000);
    }

    // Add a mutation observer to handle dynamic content changes (scroll)
    const observer = new MutationObserver(scrollToBottom);
    observer.observe(chatMessages, {
      childList: true,
      subtree: true
    });

    // Edit Title Code (kept mostly same but simplified selectors)
    const editTitleBtn = document.getElementById('editTitleBtn');
    const editTitleForm = document.getElementById('editTitleForm');
    const chatTitle = document.getElementById('chatTitle');
    const newTitleInput = document.getElementById('newTitle');
    const cancelEditBtn = document.getElementById('cancelEditBtn');

    if (editTitleBtn) { // Check existence
      editTitleBtn.addEventListener('click', () => {
        // Toggle visibility
        editTitleBtn.classList.add('d-none');
        editTitleForm.classList.remove('d-none');
        newTitleInput.focus();
      });

      cancelEditBtn.addEventListener('click', () => {
        editTitleBtn.classList.remove('d-none');
        editTitleForm.classList.add('d-none');
      });

      editTitleForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        // ... (API call logic would go here, effectively same as before but wrapped if needed)
        // For now relying on existing backend logic trigger if inline script needs it, 
        // but assuming the view logic was mostly frontend display. To be safe, I'm keeping the form behavior.
        // Actually, the previous file had the full fetch logic inside the event listener which I truncated in thoughts.
        // I will restore the fetch logic for title editing below.

        const newTitle = newTitleInput.value.trim();
        if (!newTitle) return;

        try {
          const response = await fetch(`/chats/${chatId}/title`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ title: newTitle })
          });

          if (response.ok) {
            chatTitle.textContent = newTitle;
            editTitleBtn.classList.remove('d-none');
            editTitleForm.classList.add('d-none');
            showNotification('Title updated successfully', 'success');
          } else {
            showNotification('Failed to update title', 'error');
          }
        } catch (e) {
          console.error(e);
          showNotification('Error updating title', 'error');
        }
      });
    }
  });
</script>